name: Deploy to cPanel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H tryapi.site >> ~/.ssh/known_hosts
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no tryapi@tryapi.site "echo âœ… SSH connected"

      - name: Push to cPanel
        run: |
          git remote remove cpanel || true
          git remote add cpanel ssh://tryapi@tryapi.site/home1/tryapi/repositories/upi-gateway-v2
          git push cpanel main --force
        env:
          GIT_SSH_COMMAND: "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no"
      - name: Set deployment status
        if: ${{ success() }}
        run: echo "STATUS=success" >> $GITHUB_ENV

      - name: Set deployment status
        if: ${{ failure() }}
        run: echo "STATUS=failure" >> $GITHUB_ENV

      - name: Generate Long-Lived WhatsApp Token
        id: generate_token
        run: |
          LONG_LIVED_TOKEN=$(curl -s -G "https://graph.facebook.com/v22.0/oauth/access_token" \
            --data-urlencode "grant_type=fb_exchange_token" \
            --data-urlencode "client_id=${{ secrets.WHATSAPP_APP_ID }}" \
            --data-urlencode "client_secret=${{ secrets.WHATSAPP_APP_SECRET }}" \
            --data-urlencode "fb_exchange_token=${{ secrets.WHATSAPP_SHORT_LIVED_TOKEN }}" \
            | jq -r '.access_token')
          echo "LONG_LIVED_TOKEN=$LONG_LIVED_TOKEN" >> $GITHUB_ENV

      - name: Send WhatsApp Deployment Update
        run: |
          for number in 919853174100 919706415590 919668772575
          do
            curl -i -X POST \
              https://graph.facebook.com/v22.0/${{ secrets.WHATSAPP_PHONE_NUMBER_ID }}/messages \
              -H "Authorization: Bearer ${{ env.LONG_LIVED_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"messaging_product\": \"whatsapp\",
                \"to\": \"$number\",
                \"type\": \"template\",
                \"template\": {
                  \"name\": \"deployment_update\",
                  \"language\": { \"code\": \"en_US\" },
                  \"components\": [{
                    \"type\": \"body\",
                    \"parameters\": [
                      {\"type\": \"text\", \"text\": \"${{ github.repository }}\"},
                      {\"type\": \"text\", \"text\": \"${{ github.ref_name }}\"},
                      {\"type\": \"text\", \"text\": \"${{ github.actor }}: ${{ github.event.head_commit.message }}\"},
                      {\"type\": \"text\", \"text\": \"${{ github.run_number }}\"},
                      {\"type\": \"text\", \"text\": \"${{ env.STATUS }}\"},
                      {\"type\": \"text\", \"text\": \"$(date '+%Y-%m-%d %H:%M:%S')\"}
                    ]
                  }]
                }
              }"
          done
